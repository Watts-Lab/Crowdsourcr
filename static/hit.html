<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://underscorejs.org/underscore-min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
    <script src="/static/js/autoexpand.js"></script>
    <script src="/static/js/mixins.js"></script>
    <script src="/static/js/simplemodels.js"></script>
    <script type="text/javascript">
      $(onLoad);
      var MODULES = [];

      function getAdminTask() {
        var hash = $(window.location).attr('hash');
        var prefix = '#task='
        if (hash.slice(0, prefix.length) === prefix) {
          return hash.slice(prefix.length);
        } else {
          return undefined;
        }
      }

      var haveUsedForcedHit = false;
      function getForcedHit() {
        if (haveUsedForcedHit) return undefined;
        haveUsedForcedHit = true;
        var hash = $(window.location).attr('hash');
        var prefix = '#id='
        if (hash.slice(0, prefix.length) === prefix) {
          return hash.slice(prefix.length);
        } else {
          return undefined;
        }
      }

      function showWithData(data) {
          $('.content-main').show();
          $('.login-content').hide();
          var iframe = $('<iframe src="about:blank" frameborder="0" border="0" cellspacing="0"/>');
          $('#hit-content').empty().append(iframe);
          function resizeIframe(iframe) {
            iframe.height = $(iframe).contents().find("body").prop("scrollHeight") + "px";
          }
          _.defer(function () {
            iframe.contents()[0].write(data.content);
            //resizeIframe(iframe[0]);
          });
          $('#hit-modules').empty();
          for (var i = 0; i < data.modules.length; i++){
              getModule(data.modules[i], registerModule);
          }
      }

      function requestNextTask() {
          if (getAdminTask() !== undefined) {
            $('#next-task-button').attr('disabled', true);
            $.get('/admin/tasks/' + getAdminTask(), function (data) {
                $('.loading-holder').hide();
                showWithData(data);
            });
            return;
          }
          var getData = {};
          var forcedId = getForcedHit();
          if (forcedId !== undefined) {
            getData['force'] = true;
            getData['hitid'] = +forcedId;
            getData['workerid'] = $('#worker-login-form').find('input:first').val();
          }
	  $.get('/HIT/view/', getData, function(data) {
	      $('.loading-holder').hide();

	      if (data.no_hits) {
		  $('.content-main').hide();
		  $('.login-content').hide();
		  $('.turk-verify-content').hide();
		  $('.turk-no-hits').show();
		  return;
	      }

	      if (data.needs_login) {
		  $('.login-content').show();
		  return;
	      }
 
	      $('.content-main').show();
	      $('.login-content').hide();

	      if (data.reload_for_first_task) {
		  requestNextTask();
	      } else if (data.completed_hit) {
		  $('.content-main').hide();
		  $('.login-content').hide();
		  $('.turk-verify-content').show().find('.secret-code').html(data.verify_code);
	      } else {
                  showWithData(data);
	      }
	  });
      }

      function onLoad() {
	  $('#next-task-button').click(function(evt) {
	      evt.preventDefault();
	      submitTask(requestNextTask);
	  });

	  $('#worker-login-submit').click(function(evt) {
	      evt.preventDefault();
	      $.post('/worker/login/', {'workerid' : $('#worker-login-form').find('input:first').val()}, requestNextTask);
	  });

	  requestNextTask();
      }

      function submitTask(callback) {
	  $.post('/HIT/submit/', {data : JSON.stringify(serializeModules())}, callback);
      }

      function serializeModules() {
	  var all_module_responses = [];
	  for (var i = 0; i < MODULES.length; i++) {
	      all_module_responses.push(MODULES[i].serialize());
	  }
	  return all_module_responses;
      }

      function registerModule(data) {
	  var module_container = $(document.createElement('div'));
	  var module = module_container.CType(data);
	  module.renderDisplay();
	  $('#hit-modules').append($(document.createElement('li')).html(module_container));
	  MODULES.push(module);
      }

      function getModule(module, callback) {
	  $.get('/types/view/'+module, callback);
      }
      
    </script>
    <style>
      .centering {
        margin-left: auto;
        margin-right: auto;
        display: block;
        text-align: center;
      }
      #hit-content {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow-y: hidden;
      }
      #hit-content iframe {
        margin: 0;
        width: 100%;
        height: 100%;
        border-style: none;
      }
      div.content-main {
        position: absolute; top: 0; left: 0; height: 100%; width: 100%;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <div class="header-container">
      <div class="header-title abs-center"><h3>News Crowdsourcer v1.0</h3></div>
    </div>
    <div class="loading-holder narrow-center">
      <div style="margin: 40px;">
	<img src="/static/img/ajax-loader.gif" class="centering" /><br><br>
	<p class="centering">loading HIT...</p>
      </div>
    </div>
    <div class="login-content narrow-center" style="display:none;">
      <form id="worker-login-form">
	<h4> Please input your worker id to ensure you are paid upon completing this HIT. </h4>
	<p> (If you don't know your worker id, <a href="https://www.mturk.com/mturk/dashboard"> you can find it here. </a> )</p>
	<div class="input-group">
	  <input type="text" class="form-control" placeholder="Worker ID" />
	  <span class="input-group-btn">
            <button id="worker-login-submit" class="btn btn-success" type="submit">Begin HIT</button>
	  </span>
	</div>
      </form>
    </div>
    <div class="content-main" style="display:none;">
      <div class="clear-header splitscreen-full">
	<div id="hit-content" class="splitscreen-content"></div>
      </div>
      <div class="clear-header splitscreen-full">
	<div class="splitscreen-content">
	  <ul id="hit-modules"></ul><br>
	  <button id="next-task-button" class="btn btn-success">Continue to next task</button>
	</div>
      </div>
    </div>
    <div class="turk-verify-content narrow-center" style="display: none;">
      <h4> Thanks for completing this HIT! </h4>
      <p> You should now return to mturk and submit the following code to receive payment: </p>
      <div class="well inner-hor-center">
	<h4 class="secret-code"></h4>
      </div>
    </div>
    <div class="turk-no-hits narrow-center" style="display:none;">
      <h4> No HITs. </h4>
      <p> Sorry, you are not eligible for this HIT. </p>
    </div>

<!-- begin underscore templates -->

    <script type="text/template" id="ctype-display-template">
      <form>
	<fieldset>
	  <legend data-prop="header"></legend>
	    <ul class="question-display-container"></ul>
	</fieldset>
      </form>
    </script>

    <script type="text/template" id="numericquestion-display-template">
      <div class="form-group">
	<label> <%= questiontext %> </label>
	<input class="form-control" type="number" name="<%= varname %>"/>
      </div>
    </script>
    
    <script type="text/template" id="catquestion-display-template">
      <div class="form-group">
	<label> <%= questiontext %> </label>
	<% _.each(content, function(choice) { %> <div class="radio"><label><input type="radio" name="<%= varname %>" value="<%= choice.value %>"><%= choice.text %></label></div> <% }); %>
      </div>
    </script>
    
    

 </body>
</html>
